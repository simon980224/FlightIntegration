{% extends 'base.html' %}
{% block title %}航班查詢系統{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

<style>
  h2 {
    text-align: center;
    font-weight: bold;
    margin-bottom: 2rem;
    color: #5c4033;
  }
  label {
    font-weight: 600;
    color: #5c4033;
    margin-bottom: 0.5rem;
  }
  .form-select,
  .form-control {
    border-radius: 10px;
    border: 1px solid #d6a77a;
    background-color: #fffdf9;
    color: #4b3a2f;
    padding: 0.6rem 1rem;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .form-select:focus,
  .form-control:focus {
    border-color: #c49366;
    box-shadow: 0 0 0 0.2rem rgba(212, 162, 115, 0.25);
  }
  .btn-primary {
    background-color: #d6a77a;
    border: none;
    color: #fff;
    border-radius: 8px;
    padding: 0.5rem 1.5rem;
    transition: all 0.3s ease-in-out;
  }
  .btn-primary:hover {
    background-color: #c49366;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }
  .btn-outline-light {
    border: 1px solid #c8b8a4;
    background-color: #f9f6f2;
    color: #6e4b3a;
    border-radius: 8px;
    transition: all 0.3s ease-in-out;
  }
  .btn-outline-light:hover {
    background-color: #ede3d8;
    color: #4a3527;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }
  .form-section {
    background-color: #fffdf9;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(100, 80, 60, 0.05);
    max-width: 900px;
    margin: 0 auto 2rem auto;
  }
  .flight-card {
    background-color: #fffdf9;
    border: 1px solid #e7dbcf;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(160, 130, 100, 0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    transition: all 0.3s ease-in-out;
  }
  .flight-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(160, 130, 100, 0.2);
  }
  .flight-block {
    text-align: center;
    flex: 1 1 30%;
    font-size: 1.2rem;
    position: relative;
  }
  .flight-block .date {
    font-size: 0.85rem;
    color: #aa8c72;
    margin-bottom: 0.3rem;
  }
  .flight-block .time {
    font-size: 1.8rem;
    font-weight: bold;
    color: #a3622b;
  }
  .arrow {
    font-size: 2rem;
    color: #9c8571;
    padding: 0 1rem;
  }
  .alert-warning {
    background-color: #fdf0dd;
    border-left: 4px solid #d89b5c;
    color: #765338;
    max-width: 700px;
    margin: 1rem auto;
    padding: 1rem;
  }
  .status-on-time {
    color: green;
    font-weight: bold;
  }
  .status-delayed {
    color: red;
    font-weight: bold;
  }
  .status-cancelled {
    color: #c29500;
    font-weight: bold;
  }
</style>

<div class="container mt-4">
  <h2>航班查詢</h2>

  <div class="form-section">
    <form method="POST" action="/search" id="searchForm" onsubmit="return validateDateRange();">
      <input type="hidden" name="sort_field" id="sort_field" value="{{ form_data.sort_field }}">
      <input type="hidden" name="sort_order" id="sort_order" value="{{ form_data.sort_order }}">

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="from_airport">出發地</label>
          <select class="form-select" id="from_airport" name="from_airport">
            <option value="">不限</option>
            {% for airport in airport_data %}
              <option value="{{ airport['Airport_Id'] }}" {% if form_data.from_airport == airport['Airport_Id'] %}selected{% endif %}>{{ airport['Airport_Name_ZH'] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label for="to_airport">目的地</label>
          <select class="form-select" id="to_airport" name="to_airport">
            <option value="">不限</option>
            {% for airport in airport_data %}
              <option value="{{ airport['Airport_Id'] }}" {% if form_data.to_airport == airport['Airport_Id'] %}selected{% endif %}>{{ airport['Airport_Name_ZH'] }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="departure_date">起飛日期</label>
          <input type="text" class="form-control" id="departure_date" name="departure_date" value="{{ form_data.departure_date or '' }}">
        </div>
        <div class="col-md-6">
          <label for="arrival_date">抵達日期</label>
          <input type="text" class="form-control" id="arrival_date" name="arrival_date" value="{{ form_data.arrival_date or '' }}">
        </div>
      </div>

      <div class="mb-3">
        <label>航空公司</label>
        <div class="mb-2">
          <button type="button" class="btn btn-sm btn-outline-dark me-2" onclick="selectAllAirlines(true)">全選</button>
          <button type="button" class="btn btn-sm btn-outline-dark" onclick="selectAllAirlines(false)">清除</button>
        </div>
        <div class="form-check form-check-inline">
          {% for airline in airline_data %}
            <div class="form-check form-check-inline">
              <input class="form-check-input airline-checkbox" type="checkbox" name="airline_ids" value="{{ airline['Airline_Id'] }}" id="airline_{{ airline['Airline_Id'] }}" checked>
              <label class="form-check-label me-3" for="airline_{{ airline['Airline_Id'] }}">{{ airline['Airline_Name_ZH'] }}</label>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="text-center">
        <button class="btn btn-primary px-5" type="submit" id="submitBtn">查詢</button>
        <button class="btn btn-outline-light px-5" type="button" onclick="clearFilters()">清除條件</button>
      </div>
    </form>
  </div>

  {% if flights is defined %}
    <h4 class="text-center mb-3">查詢結果：</h4>
    {% if flights %}
      {% for flight in flights %}
        <div class="flight-card">
          <div class="flight-block">
            <div class="date">{{ flight['Scheduled_Departure_Time'].strftime('%Y-%m-%d') }}</div>
            <div class="time">{{ flight['Scheduled_Departure_Time'].strftime('%H:%M') }}</div>
            <div>{{ flight['From_Airport'] }}</div>
          </div>
          <div class="arrow">→</div>
          <div class="flight-block">
            <div class="date">{{ flight['Scheduled_Arrival_Time'].strftime('%Y-%m-%d') }}</div>
            <div class="time">{{ flight['Scheduled_Arrival_Time'].strftime('%H:%M') }}</div>
            <div>{{ flight['To_Airport'] }}</div>
          </div>
          <div class="flight-block">
            <div class="date">狀態</div>
            <div class="time">
              {% set status = flight['Status'] | trim | lower %}
              {% if status == 'on time' %}
                 <span class="badge bg-success">準時</span>
              {% elif status == 'delayed' %}
                 <span class="badge bg-danger">延遲</span>
              {% elif status == 'cancelled' %}
                 <span class="badge bg-warning text-dark">已取消</span>
              {% else %}
                 <span class="badge bg-light text-dark">{{ flight['Status'] }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-warning">查無符合條件的航班</div>
    {% endif %}
  {% endif %}
</div>

<script>
function validateDateRange() {
  const dep = document.getElementById("departure_date").value;
  const arr = document.getElementById("arrival_date").value;
  if (dep && arr && dep > arr) {
    alert("⚠️ 起飛日期不能晚於抵達日期！");
    return false;
  }
  return true;
}
function clearFilters() {
  document.getElementById("from_airport").value = "";
  document.getElementById("to_airport").value = "";
  if (flatpickrInstance1) flatpickrInstance1.clear();
  if (flatpickrInstance2) flatpickrInstance2.clear();
  document.querySelectorAll('input[name="airline_ids"]').forEach(cb => cb.checked = false);
}
function selectAllAirlines(status) {
  document.querySelectorAll('input[name="airline_ids"]').forEach(cb => cb.checked = status);
}
window.addEventListener("DOMContentLoaded", function () {
  const today = new Date().toISOString().split("T")[0];
  const depInput = document.getElementById("departure_date");
  const arrInput = document.getElementById("arrival_date");
  if (!depInput.value) depInput.value = today;
  if (!arrInput.value) arrInput.value = today;
  flatpickrInstance1 = flatpickr("#departure_date", { locale: "zh", dateFormat: "Y-m-d", altInput: true, altFormat: "Y年m月d日" });
  flatpickrInstance2 = flatpickr("#arrival_date", { locale: "zh", dateFormat: "Y-m-d", altInput: true, altFormat: "Y年m月d日" });
  updateToAirportOptions();
  document.getElementById("from_airport").addEventListener("change", updateToAirportOptions);
});
let originalToOptions = [];
function updateToAirportOptions() {
  const fromSelect = document.getElementById("from_airport");
  const toSelect = document.getElementById("to_airport");
  const selectedFrom = fromSelect.value;
  if (originalToOptions.length === 0) {
    originalToOptions = Array.from(toSelect.options).map(opt => ({ value: opt.value, text: opt.text, selected: opt.selected }));
  }
  toSelect.innerHTML = "";
  originalToOptions.forEach(opt => {
    if (opt.value === selectedFrom && selectedFrom !== "") return;
    const option = document.createElement("option");
    option.value = opt.value;
    option.text = opt.text;
    if (opt.selected && opt.value !== selectedFrom) option.selected = true;
    toSelect.appendChild(option);
  });
}
const normalizeStatus = (status) => {
      if (!status) return 'unknown';
      status = status.toLowerCase();
      if (status.includes('cancel')) return 'cancelled';
      if (status.includes('delay')) return 'delayed';
      if (status.includes('on time') || status.includes('ontime')) return 'on time';
      return 'unknown';
}
</script>

{% endblock %}
