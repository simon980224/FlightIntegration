{% extends 'base.html' %}
{% block title %}航班查詢系統{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

<div class="container mt-5">
  <h2 class="text-center mb-4">查詢航班</h2>
  <form method="POST" action="/search" id="searchForm">
    <input type="hidden" name="sort_field" id="sort_field" value="{{ form_data.sort_field }}">
    <input type="hidden" name="sort_order" id="sort_order" value="{{ form_data.sort_order }}">

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="from_airport">出發地</label>
        <select class="form-select" id="from_airport" name="from_airport">
          <option value="">不限</option>
          {% for airport in airport_data %}
            <option value="{{ airport['Airport_Id'] }}"
              {% if form_data.from_airport == airport['Airport_Id'] %}selected{% endif %}>
              {{ airport['Airport_Name_ZH'] }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label for="to_airport">目的地</label>
        <select class="form-select" id="to_airport" name="to_airport">
          <option value="">不限</option>
          {% for airport in airport_data %}
            <option value="{{ airport['Airport_Id'] }}"
              {% if form_data.to_airport == airport['Airport_Id'] %}selected{% endif %}>
              {{ airport['Airport_Name_ZH'] }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="departure_date">起飛日期</label>
        <input type="text" id="departure_date" name="departure_date" class="form-control"
          value="{{ form_data.departure_date or '' }}">
      </div>
      <div class="col-md-6">
        <label for="arrival_date">抵達日期</label>
        <input type="text" id="arrival_date" name="arrival_date" class="form-control"
          value="{{ form_data.arrival_date or '' }}">
      </div>
    </div>

    <div class="mb-3">
      <label>航空公司</label>
      <div class="mb-2">
        <button type="button" class="btn btn-sm btn-secondary me-2" onclick="selectAllAirlines(true)">全選</button>
      </div>
      <div class="form-check form-check-inline">
        {% for airline in airline_data %}
          <div class="form-check form-check-inline">
            <input class="form-check-input airline-checkbox" type="checkbox"
              name="airline_ids" value="{{ airline['Airline_Id'] }}"
              id="airline_{{ airline['Airline_Id'] }}"
              {% if airline['Airline_Id'] in form_data.airline_ids %}checked{% endif %}>
            <label class="form-check-label me-3" for="airline_{{ airline['Airline_Id'] }}">
              {{ airline['Airline_Name_ZH'] }}
            </label>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="text-center">
      <button class="btn btn-primary" type="submit" id="submitBtn">查詢</button>
      <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">清除條件</button>
    </div>
  </form>

  {% if flights is defined %}
    <hr class="my-4">
    <h4>查詢結果：</h4>
    {% if flights %}
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>航空公司</th>
            <th>出發地</th>
            <th>目的地</th>
            <th class="sortable-header" onclick="toggleSort('Scheduled_Departure_Time')">
              起飛時間 <span id="icon_Scheduled_Departure_Time"></span>
            </th>
            <th class="sortable-header" onclick="toggleSort('Scheduled_Arrival_Time')">
              抵達時間 <span id="icon_Scheduled_Arrival_Time"></span>
            </th>
            <th>狀態</th>
          </tr>
        </thead>
        <tbody>
          {% for flight in flights %}
            <tr>
              <td>{{ flight['Airline_Name_ZH'] }}</td>
              <td>{{ flight['From_Airport'] }}</td>
              <td>{{ flight['To_Airport'] }}</td>
              <td>{{ flight['Scheduled_Departure_Time'] }}</td>
              <td>{{ flight['Scheduled_Arrival_Time'] }}</td>
              <td>
                {% set status = flight['Status'] | trim | lower %}
                {% if status == 'on time' %}
                  <span class="badge bg-success">準時</span>
                {% elif status == 'delayed' %}
                  <span class="badge bg-danger">延遲</span>
                {% elif status == 'cancelled' %}
                  <span class="badge bg-warning text-dark">已取消</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ flight['Status'] }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="alert alert-warning">查無符合條件的航班</div>
    {% endif %}
  {% endif %}
</div>

<script>
  let flatpickrInstance1, flatpickrInstance2;

  window.addEventListener("DOMContentLoaded", function () {
    flatpickrInstance1 = flatpickr("#departure_date", {
      locale: "zh",
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "Y年m月d日"
    });

    flatpickrInstance2 = flatpickr("#arrival_date", {
      locale: "zh",
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "Y年m月d日"
    });

    updateToAirportOptions();
    document.getElementById("from_airport").addEventListener("change", updateToAirportOptions);
  });

  function clearFilters() {
    document.getElementById("from_airport").value = "";
    document.getElementById("to_airport").value = "";
    if (flatpickrInstance1) flatpickrInstance1.clear();
    if (flatpickrInstance2) flatpickrInstance2.clear();
    document.querySelectorAll('input[name="airline_ids"]').forEach(cb => cb.checked = false);
  }

  function selectAllAirlines(status) {
    document.querySelectorAll('input[name="airline_ids"]').forEach(cb => cb.checked = status);
  }

  let originalToOptions = [];

  function updateToAirportOptions() {
    const fromSelect = document.getElementById("from_airport");
    const toSelect = document.getElementById("to_airport");
    const selectedFrom = fromSelect.value;

  // 第一次儲存原始目的地選項
    if (originalToOptions.length === 0) {
      originalToOptions = Array.from(toSelect.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      selected: opt.selected
    }));
  }

  // 清空目的地選單
    toSelect.innerHTML = "";

  // 加回除了「選到的出發地」以外的所有選項（但保留「不限」）
    originalToOptions.forEach(opt => {
    // 只排除與出發地相同且不是不限的
      if (opt.value === selectedFrom && selectedFrom !== "") {
        return;
      }

      const option = document.createElement("option");
      option.value = opt.value;
      option.text = opt.text;

    // 恢復原本選取狀態
      if (opt.selected && opt.value !== selectedFrom) {
        option.selected = true;
      }

      toSelect.appendChild(option);
    });

}

  function toggleSort(field) {
    const currentField = document.getElementById("sort_field").value;
    const currentOrder = document.getElementById("sort_order").value;
    let newOrder = "asc";
    if (currentField === field && currentOrder === "asc") {
      newOrder = "desc";
    }
    document.getElementById("sort_field").value = field;
    document.getElementById("sort_order").value = newOrder;
    document.getElementById("searchForm").submit();
  }

  document.getElementById("searchForm").addEventListener("submit", function (e) {
    const from = document.getElementById("from_airport").value;
    const to = document.getElementById("to_airport").value;
    if (from && to && from === to) {
      alert("出發地與目的地不可相同！");
      e.preventDefault();
      return;
    }

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> 查詢中...`;
  });
</script>

{% endblock %}
